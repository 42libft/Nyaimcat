# Codex連携オートメーション - 実装計画

## フェーズ構成

### Phase 1: コマンド仕様とデータモデルの策定
1. Slash コマンド要件整理（`/task create`, `/work start`, `/work status` などの引数・レスポンス定義）
   - `/task create` の仕様を確定し、実装を完了。`/work start` / `/work status` は次フェーズで検討継続。
2. ✅ プロンプト保存先フォーマット決定（ディレクトリ構成、ファイル命名規則、メタデータ形式）
3. ⏳ セキュリティ方針のドラフト（権限ロール、入力バリデーション、危険コマンド遮断ルール）

### Phase 2: Bot 側機能実装（プロンプト蓄積）
1. Slash コマンド登録とハンドラ実装（新規依頼を受け取りファイル保存）
2. Inbox 管理ツール作成（一覧表示、検査、削除用ユーティリティ）
   - ✅ `npm run task-inbox` で Inbox の一覧／詳細／削除を実行できる CLI を追加。
   - ⏳ ファイル検査時のメタデータ編集・バリデーション強化は今後の改善枠。
3. エラーハンドリングと利用者フィードバック整備（応答メッセージ、ログ出力）

### Phase 3: Codex CLI 連携ランナーの構築
1. Bot → Codex CLI 呼び出しスクリプト実装（依頼選択、環境変数整備）
2. CLI 実行結果の収集（標準出力／生成ファイル／ステータスコード）
3. 実行キュー／同時実行制御（直列処理、キャンセル対応の検討）

### Phase 4: 結果通知と Plans 運用自動化
1. Codex 側出力を Discord に送るロジック実装（Follow-up メッセージ等）
2. Plans.md 自動生成ロジックのテンプレート化（exec plan 準拠）
3. `/work status` / `/work cancel` の実装と進捗管理フロー整備

### Phase 5: セキュリティ・運用強化
1. コマンド利用権限の最終調整（Bot permissions / Guild roles）
2. 監視・アラート（ログ監視、失敗時通知、`/status` 実装）
3. ドキュメント整備（運用手順、トラブルシュートガイド、リリースノート）

## リスクと対策
- **Codex CLI の長時間実行**: タイムアウト制御とステータス更新を導入。必要に応じて処理時間に応じた分割実行を検討。  
- **危険コマンドの流入**: フィルタリングと審査ステップを導入し、手動承認フローを追加できるようにする。  
- **ファイル競合**: Task/Plans 更新は排他制御（ファイルロックやジョブキュー）で整合性を保つ。  
- **Slash コマンドの権限制御**: 特定ロール限定＆監査ログを保存し、不正利用時に即座に停止できるようにする。

## 最新の進捗（2025-10-16）
- `tasks/inbox/` を横断的に扱う CLI (`npm run task-inbox`) を作成し、一覧表示・内容確認・削除の 3 操作を用意した。
- Bot ランタイムと CLI の双方から同一の Inbox ユーティリティを利用できるようにし、リポジトリルートの検出ロジックを共通化した。

## 最新の進捗（2024-02-14）
- `/task create` Slash コマンドの保存先が `bot-runtime/tasks/` に誤って向いていた問題を修正し、リポジトリ直下 `tasks/inbox/` に確実に保存されるようにした。
- 既存の保存ロジックと監査ログ処理はそのまま維持しつつ、フォルダ作成処理が正しいパスを対象にすることを確認した。

## 最新の進捗（2024-02-13）
- `/task create` Slash コマンドを実装し、概要・詳細・優先度を受け取ってローカルファイルに保存できるようにした。
- `tasks/inbox/` ディレクトリを作成し、YAML Front Matter 付き Markdown で Codex 依頼を蓄積するワークフローを整備した。
- 保存処理と監査ログ送信、Discord への応答テンプレートを整備し、入力バリデーション（概要または詳細の必須化）を追加した。

## Slash コマンド仕様ドラフト（v2024-02-13）
- `/task create`
  - `title` (必須): 3〜150 文字。ファイル名スラッグとメタデータ `title` に使用。
  - `summary` (任意): 5〜500 文字。概要として Front Matter と本文両方に格納。
  - `details` (任意): 10〜1900 文字。詳細セクションとして保存。概要が未入力の場合はこちらが必須。
  - `priority` (任意): `low` / `normal` / `high`。Front Matter に `priority` / `priority_label` を書き込み、応答メッセージにも表示。
- **バリデーション**: `summary` と `details` のいずれかは必須。CRLF を LF に正規化し、前後の空白を除去して空入力を防止。
- **応答フロー**: 受理時にエフェメラルで進捗メッセージ → 保存完了後にファイル名と優先度を通知。失敗時はエラーメッセージを返す。

## プロンプト保存フォーマット
- 保存先: リポジトリ直下 `tasks/inbox/`。ファイル名は `YYYY-MM-DDTHH-MM-SS-sss-title-slug.md`。
- コンテンツ構造:
  - YAML Front Matter（`title`, `priority`, `priority_label`, `summary`, `created_at`, `author.id`, `author.tag`, `channel_id`, `interaction_id`）。
  - 本文 `## 概要` / `## 詳細` セクションと、自動生成の署名。
- CLI / Codex 側は Front Matter をパースすれば依頼メタデータを取得できる。本文は Codex への提示テキストとして使用する。

## 決定事項とメモ
- Codex CLI 側に引き渡す最低情報として、Discord ユーザー ID・チャンネル ID・優先度・概要/詳細文を Markdown 1 ファイルに集約する。
- 依頼登録は Slash コマンド経由のみとし、後続の `/work start` などは今後のフェーズで設計。既存の監査ログ基盤を流用して失敗時の追跡を行う。
- ファイル名スラッグは Unicode 正規化 (NFKC) と英数字・ハイフンに制限し、ローカルファイルシステム互換を優先する。
- Bot 実行時のカレントディレクトリに依存せず、リポジトリ直下 `tasks/` を明示的に参照する。
- CLI 経由の削除操作は誤操作防止のため `--force` 指定を必須とし、Slash コマンドと同一のユーティリティでパス解決する。

## 次のアクション
1. `/task create` の利用感フィードバックを収集し、必要ならオプション（添付 URL / 参照ファイルなど）を追加する。
2. `/work start` / `/work status` の仕様ドラフトと安全装置（権限制御、入力制限）の検討を進める。
3. Codex CLI 連携用の実行ランナー設計を行い、Phase 2 実装タスクを洗い出す。
