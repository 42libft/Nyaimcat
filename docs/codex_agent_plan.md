# Codex連携オートメーション - 実装計画

## フェーズ構成

### Phase 1: コマンド仕様とデータモデルの策定
1. Slash コマンド要件整理（`/task create`, `/work start`, `/work status` などの引数・レスポンス定義）
2. プロンプト保存先フォーマット決定（ディレクトリ構成、ファイル命名規則、メタデータ形式）
3. セキュリティ方針のドラフト（権限ロール、入力バリデーション、危険コマンド遮断ルール）

### Phase 2: Bot 側機能実装（プロンプト蓄積）
1. Slash コマンド登録とハンドラ実装（新規依頼を受け取りファイル保存）
2. Inbox 管理ツール作成（一覧表示、検査、削除用ユーティリティ）
3. エラーハンドリングと利用者フィードバック整備（応答メッセージ、ログ出力）

### Phase 3: Codex CLI 連携ランナーの構築
1. Bot → Codex CLI 呼び出しスクリプト実装（依頼選択、環境変数整備）
2. CLI 実行結果の収集（標準出力／生成ファイル／ステータスコード）
3. 実行キュー／同時実行制御（直列処理、キャンセル対応の検討）

### Phase 4: 結果通知と Plans 運用自動化
1. Codex 側出力を Discord に送るロジック実装（Follow-up メッセージ等）
2. Plans.md 自動生成ロジックのテンプレート化（exec plan 準拠）
3. `/work status` / `/work cancel` の実装と進捗管理フロー整備

### Phase 5: セキュリティ・運用強化
1. コマンド利用権限の最終調整（Bot permissions / Guild roles）
2. 監視・アラート（ログ監視、失敗時通知、`/status` 実装）
3. ドキュメント整備（運用手順、トラブルシュートガイド、リリースノート）

## リスクと対策
- **Codex CLI の長時間実行**: タイムアウト制御とステータス更新を導入。必要に応じて処理時間に応じた分割実行を検討。  
- **危険コマンドの流入**: フィルタリングと審査ステップを導入し、手動承認フローを追加できるようにする。  
- **ファイル競合**: Task/Plans 更新は排他制御（ファイルロックやジョブキュー）で整合性を保つ。  
- **Slash コマンドの権限制御**: 特定ロール限定＆監査ログを保存し、不正利用時に即座に停止できるようにする。

## 次のアクション
1. Phase 1 の詳細仕様ドラフトを執筆し、レビューを受ける。  
2. Bot リポジトリに `tasks/inbox/` など必要なディレクトリを追加する。  
3. MVP 実装に向けて Phase 2 に着手する準備（開発ブランチ作成、環境変数整理）。
