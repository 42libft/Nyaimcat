# Nyaimlab 次期対応計画

## 現状サマリ
- Node.js ランタイムは `/verify post` `/roles post` `/introduce` `/feedback` を含む主要 Slash コマンドと監査ログ送信、オンボーディング DM フォールバックまで稼働。Verify ロール剥奪監査 (`verify.revoke`) と退会イベント (`member.leave`) も実装済み。
- Python 製 ESCL コレクタは CSV / Excel 生産と再集計ロジックを提供し、Node.js から CLI 経由で呼び出せる。
- FastAPI 管理 API は設定保存・監査ログ検索・スクリム設定ドライランまでカバーするが、ストレージはインメモリで永続化されていない。
- React ダッシュボードは全タブ（Welcome〜Scrims/Settings）、監査ログビューア、YAML 差分＆PR 起票、スクリムドライラン操作まで実装。Introduce 拡張や詳細バリデーションは未着手。
- スクリム補助は API／ダッシュボードで設定・ドライランが可能な段階だが、Bot 側での通知／集計処理は未実装。

## 直近の進捗
- Bot プレゼンスにヘルス状態を反映する PresenceManager を導入し、正常時は `🟢 利用可能`、警告／障害時は `⚠️` / `🛑` を表示して利用可否を即時把握できるようにした。
- Verify ロール剥奪検知に伴う監査ログ (`verify.revoke`) と退会ハンドリング (`member.leave`) を追加し、監査線が整備された。
- Python ESCL CLI を Node.js ランタイムに統合し、`/version` `/escl_from_parent_csv` `/escl_from_parent_xlsx` を Slash コマンドとして公開。
- `/feedback` コマンドを追加し、Discord からのバグ報告／アイデアをローカル Markdown として保存・監査ログ送信する導線を構築。
- ダッシュボードの Scrims タブから `dry_run`／`run` を API に投げ、監査 ID を取得できるようにした。
- README を Codex 連携コマンドに合わせて刷新し、`/help` Slash コマンドで主要な操作ガイドを即時参照できるようにした。
- `/help` コマンドにカテゴリ／コマンド指定オプションを追加し、サーバー基本ガイドから個別機能の詳細まで自己完結できるヘルプを提供。

## 優先課題（短期）
1. **スクリム補助ワークフローの具体化**  
   - ダッシュボード → API → Bot のデータコントラクト確定。  
   - Bot 側での通知スケジューリング、ESCL コレクタ／監査連携、失敗時リカバリ方針を定義。
2. **Introduce モーダル拡張とモデレーション**  
   - セレクト項目／NG ワード／添付ファイル可否の仕様を固め、API・ダッシュボード・Bot のバリデーション／Embed 整形を拡張。  
   - 投稿失敗時の監査ログ詳細化と再投稿フローを整理。
3. **運用ヘルスチェックと権限監視**  
   - 起動時のロール／チャンネル権限チェック、Slash コマンド同期確認を自動化。  
   - `/health`（Slash もしくは REST）の実装と監視チャンネルへの定期通知を検討。
4. **設定バリデーションと障害時リカバリ改善**  
   - Bot 側での設定 JSON スキーマ検証、差分による hot reload ロールバック。  
   - Dash/API での必須項目チェックと監査ログ／UI 上のエラー提示強化。

## 中期課題（バックエンド・フロントエンド）
- **管理 API の永続化と監査拡張**  
  - SQLite/Postgres 等のストレージ導入、監査ログ長期保存、エクスポートフィルタの強化。  
  - 監査 ID をキーにダッシュボードから詳細参照できるよう API を拡張。
- **Webhook／外部通知連携**  
  - 設定変更や Bot 障害を GitHub / Discord / Ops チャネルへ通知する仕組みを設計。  
  - 将来的な CI/CD（PR マージ時の自動反映）に向けた Webhook 受信エンドポイントを整理。
- **Introduce / Scrims UI の高度化**  
  - 自己紹介フォームのプレビュー強化、NG ワード管理 UI、ファイル添付設定を追加。  
  - スクリム設定のカレンダー表示・実行ログビューアを検討。
- **入力バリデーションとレビュー支援**  
  - フォーム入力時の即時バリデーション・差分サマリ生成。  
  - PR 作成時の自動テンプレート生成やレビューチェックリストを導入。

## インフラ／運用タスク
- **Secrets・権限運用ガイド整備**  
  - Bot トークン、API トークン、GitHub PAT の保管ポリシー・権限スコープ・ローテーション手順を文書化。
- **Welcome／Verify／Roles 文言最終レビュー**  
  - 本番公開用メッセージのレビューと approve 手順を確立し、ダッシュボード既定値を更新。
- **テストギルドでの E2E 検証手順書**  
  - Slash コマンド実行 → 監査ログ確認 → 設定 PR 反映までの流れと失敗時トリアージを標準化。
- **ダッシュボード API × GitHub 同期自動化検討**  
  - Webhook／スケジューラでの PR マージ検知 → Bot 設定更新を自動化する案を比較検討。
- **障害時オペレーション整備**  
  - 監査ログ確認、設定ロールバック、権限再同期、ESCL CLI 障害時の手動実行手順をまとめる。

## 進行管理メモ
- スクリム補助・Introduce 拡張は要件依存度が高いため、先に関係者ヒアリング／仕様ワークショップを実施してから実装に入る。  
- 永続化や Webhook など互換性に影響する変更は、API バージョニング方針を決めた上で段階的に導入する。  
- インフラ文書化・E2E 手順は次回リリースサイクルまでにドラフトを用意し、運用チームレビューを受ける。  
- Bot ヘルスチェックは運用の即効性が高いため、優先課題として開発スプリント初期での着手を想定する。
