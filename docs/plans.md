# Nyaimlab 次期対応計画

## 現状サマリ
- Node.js ランタイムは `/verify post` `/roles post` `/introduce` `/feedback` を含む主要 Slash コマンドと監査ログ送信、オンボーディング DM フォールバックまで稼働。Verify ロール剥奪監査 (`verify.revoke`) と退会イベント (`member.leave`) も実装済み。
- Python 製 ESCL コレクタは CSV / Excel 生産と再集計ロジックを提供し、Node.js から CLI 経由で呼び出せる。
- FastAPI 管理 API は設定保存・監査ログ検索・スクリム設定ドライランまでカバーするが、ストレージはインメモリで永続化されていない。
- React ダッシュボードは全タブ（Welcome〜Scrims/Settings）、監査ログビューア、YAML 差分＆PR 起票、スクリムドライラン操作まで実装。Introduce 拡張や詳細バリデーションは未着手。
- スクリム補助は API／ダッシュボードで設定・ドライランが可能な段階だが、Bot 側での通知／集計処理は未実装。

## 直近の進捗
- Bot プレゼンスにヘルス状態を反映する PresenceManager を導入し、正常時は `🟢 利用可能`、警告／障害時は `⚠️` / `🛑` を表示して利用可否を即時把握できるようにした。
- Verify ロール剥奪検知に伴う監査ログ (`verify.revoke`) と退会ハンドリング (`member.leave`) を追加し、監査線が整備された。
- Python ESCL CLI を Node.js ランタイムに統合し、`/version` `/escl_from_parent_csv` `/escl_from_parent_xlsx` を Slash コマンドとして公開。
- `/feedback` コマンドを追加し、Discord からのバグ報告／アイデアをローカル Markdown として保存・監査ログ送信する導線を構築。
- ダッシュボードの Scrims タブから `dry_run`／`run` を API に投げ、監査 ID を取得できるようにした。
- README を Codex 連携コマンドに合わせて刷新し、`/help` Slash コマンドで主要な操作ガイドを即時参照できるようにした。
- `/help` コマンドにカテゴリ／コマンド指定オプションを追加し、サーバー基本ガイドから個別機能の詳細まで自己完結できるヘルプを提供。

## 優先課題（短期）
1. **スクリム補助ワークフローの具体化**  
   - ダッシュボード → API → Bot のデータコントラクト確定。  
   - Bot 側での通知スケジューリング、ESCL コレクタ／監査連携、失敗時リカバリ方針を定義。
2. **Introduce モーダル拡張とモデレーション**  
   - セレクト項目／NG ワード／添付ファイル可否の仕様を固め、API・ダッシュボード・Bot のバリデーション／Embed 整形を拡張。  
   - 投稿失敗時の監査ログ詳細化と再投稿フローを整理。
3. **運用ヘルスチェックと権限監視**  
   - 起動時のロール／チャンネル権限チェック、Slash コマンド同期確認を自動化。  
   - `/health`（Slash もしくは REST）の実装と監視チャンネルへの定期通知を検討。
4. **設定バリデーションと障害時リカバリ改善**  
   - Bot 側での設定 JSON スキーマ検証、差分による hot reload ロールバック。  
   - Dash/API での必須項目チェックと監査ログ／UI 上のエラー提示強化。

## 中期課題（バックエンド・フロントエンド）
- **管理 API の永続化と監査拡張**  
  - SQLite/Postgres 等のストレージ導入、監査ログ長期保存、エクスポートフィルタの強化。  
  - 監査 ID をキーにダッシュボードから詳細参照できるよう API を拡張。
- **Webhook／外部通知連携**  
  - 設定変更や Bot 障害を GitHub / Discord / Ops チャネルへ通知する仕組みを設計。  
  - 将来的な CI/CD（PR マージ時の自動反映）に向けた Webhook 受信エンドポイントを整理。
- **Introduce / Scrims UI の高度化**  
  - 自己紹介フォームのプレビュー強化、NG ワード管理 UI、ファイル添付設定を追加。  
  - スクリム設定のカレンダー表示・実行ログビューアを検討。
- **入力バリデーションとレビュー支援**  
  - フォーム入力時の即時バリデーション・差分サマリ生成。  
  - PR 作成時の自動テンプレート生成やレビューチェックリストを導入。

## インフラ／運用タスク
- **Secrets・権限運用ガイド整備**  
  - Bot トークン、API トークン、GitHub PAT の保管ポリシー・権限スコープ・ローテーション手順を文書化。
- **Welcome／Verify／Roles 文言最終レビュー**  
  - 本番公開用メッセージのレビューと approve 手順を確立し、ダッシュボード既定値を更新。
- **テストギルドでの E2E 検証手順書**  
  - Slash コマンド実行 → 監査ログ確認 → 設定 PR 反映までの流れと失敗時トリアージを標準化。
- **ダッシュボード API × GitHub 同期自動化検討**  
  - Webhook／スケジューラでの PR マージ検知 → Bot 設定更新を自動化する案を比較検討。
- **障害時オペレーション整備**  
  - 監査ログ確認、設定ロールバック、権限再同期、ESCL CLI 障害時の手動実行手順をまとめる。

## 進行管理メモ
- スクリム補助・Introduce 拡張は要件依存度が高いため、先に関係者ヒアリング／仕様ワークショップを実施してから実装に入る。  
- 永続化や Webhook など互換性に影響する変更は、API バージョニング方針を決めた上で段階的に導入する。  
- インフラ文書化・E2E 手順は次回リリースサイクルまでにドラフトを用意し、運用チームレビューを受ける。  
- Bot ヘルスチェックは運用の即効性が高いため、優先課題として開発スプリント初期での着手を想定する。
- ルート直下の ESCL 関連ユーティリティ／ダンプを整理し、`scripts/escl/` と `data/escl/` 配下へ移動済み。CLI 既定パスも新構成に合わせて更新した。

## ESCL スクリム自動エントリー Bot v2

### 現状サマリ
- Python 実装で `/set-team` `/list-active` `/entry` と応募スケジューラ（0.5 秒 × 最大 6 回リトライ）が完成済み。ESCL API クライアント、teamId 永続化、ユニットテストも揃っている。
- Node.js ランタイムにはまだ Slash コマンドを移植しておらず、稼働中 Bot ではコマンドが表示されない。ジョブ永続化や再起動復元も未実装。
- 2025-10-15 時点で ESCL API クライアント・teamId 永続化・スケジューラ／コマンド統合まで開発。スレッド作成失敗フォールバックや 429 対応も組み込み済み。

### 直近の追加要求（2025-10-18）
- `/entry` に任意の時刻を指定できるオプションを追加し、未指定時は前日 0:00 JST を維持する。
- 応募を即時 1 回だけ送信する Slash コマンド（仮称 `/entry-now`）を提供する。
- リトライ回数を 3 回へ縮小し、429 時の待機ロジックなどの制御値を新設定に合わせる（即時コマンドはリトライなしを想定）。

### 次アクション（短期）
1. Python 実装をアップデートし、可変時刻オプション／即時応募コマンド／リトライ 3 回へ切り替える。
2. 追加要件を満たす形で Node.js ランタイムへ Slash コマンドを移植し、既存の Codex 連携コマンドと併存できるよう整理する。
3. 移植時の設定・環境変数・権限要件を洗い出し、README や運用手順を更新する。
4. Node 側で安定稼働を確認したら Python 側の同名 Slash コマンドを無効化／削除し、運用を一本化する。
5. 詳細な作業手順と進捗管理は `docs/task.md` の Exec Plan（「ESCL スクリム自動エントリー Bot v2」）を参照・更新する。

### 中期検討事項
- 応募ジョブを永続化し、Bot 再起動後に復元できる仕組みを追加（現状はメモリ保持のみ）。軽量なファイル／SQLite 等を候補にし、性能影響を確認する。
- ESCL API のエラーレスポンス（特に 422/429）バリエーションを調査し、Node 実装でも同じ挙動になるようモジュール化する。
- 複数ランタイム（Python / Node）同時運用を避け、コマンド群を一本化する段階的な移行計画を策定する。

### リスク / メモ
- Discord スレッド作成権限が不足するギルドではチャンネル本体で進捗共有するフォールバックが必要。
- JWT の有効期限とローテーション手順を明文化し、深夜帯での失効リスクを抑える。
- Node 移植後に Python 側を停止する場合は、既存の CLI ツール（CSV/XLSX 出力）との整合性を事前確認する。
