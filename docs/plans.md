# Nyaimlab 次期対応計画

## 現状サマリ
- Node.js ランタイムは `/verify post` `/roles post` `/introduce` `/feedback` を含む主要 Slash コマンドと監査ログ送信、オンボーディング DM フォールバックまで稼働。Verify ロール剥奪監査 (`verify.revoke`) と退会イベント (`member.leave`) も実装済み。
- Python 製 ESCL コレクタは CSV / Excel 生産と再集計ロジックを提供し、Node.js から CLI 経由で呼び出せる。
- FastAPI 管理 API は設定保存・監査ログ検索・スクリム設定ドライランまでカバーするが、ストレージはインメモリで永続化されていない。
- React ダッシュボードは全タブ（Welcome〜Scrims/Settings）、監査ログビューア、YAML 差分＆PR 起票、スクリムドライラン操作まで実装。Introduce 拡張や詳細バリデーションは未着手。
- スクリム補助は API／ダッシュボードで設定・ドライランが可能な段階だが、Bot 側での通知／集計処理は未実装。

## 直近の進捗
- Bot プレゼンスにヘルス状態を反映する PresenceManager を導入し、正常時は `🟢 利用可能`、警告／障害時は `⚠️` / `🛑` を表示して利用可否を即時把握できるようにした。
- Verify ロール剥奪検知に伴う監査ログ (`verify.revoke`) と退会ハンドリング (`member.leave`) を追加し、監査線が整備された。
- Python ESCL CLI を Node.js ランタイムに統合し、`/version` `/escl_from_parent_csv` `/escl_from_parent_xlsx` を Slash コマンドとして公開。
- `/feedback` コマンドを追加し、Discord からのバグ報告／アイデアをローカル Markdown として保存・監査ログ送信する導線を構築。
- ダッシュボードの Scrims タブから `dry_run`／`run` を API に投げ、監査 ID を取得できるようにした。
- README を Codex 連携コマンドに合わせて刷新し、`/help` Slash コマンドで主要な操作ガイドを即時参照できるようにした。
- `/help` コマンドにカテゴリ／コマンド指定オプションを追加し、サーバー基本ガイドから個別機能の詳細まで自己完結できるヘルプを提供。
- `/entry` コマンドに任意時刻指定オプションと即時送信用 `/entry-now` を追加し、Python スケジューラのリトライ上限を 3 回へ統一。ユニットテストを更新して新挙動を担保。
- Node.js ランタイムに `/set-team` `/list-active` `/entry` `/entry-now` を実装し、ESCL 応募の予約・即時送信を TypeScript 側で完結できるようにした。TeamStore／EntryScheduler／ESCL API クライアントも移植してユニットテストを整備。
- EntryScheduler に JSON ベースの応募ジョブ永続化と再起動復元を実装し、保存・復元テストでストア整合性と再実行を検証できるようにした。
- `/escl account` サブコマンドと暗号化 CredentialStore を導入し、Slash コマンドからアカウント登録・一覧・削除・デフォルト設定、応募コマンドからのアカウント指定、401 発生時の自動失効マークとローテーション CLI を提供した。
- ESCL 関連コマンド群をコードレビューし、`/escl account` のテンプレートリテラルエスケープ不備と EntryScheduler の認証プロバイダー型定義、tsconfig の `include` 設定漏れを修正して TypeScript ビルドを復旧。

## 優先課題（短期）
1. **スクリム補助ワークフローの Bot 実装**  
   - ダッシュボード／管理 API と連携する通知テンプレート・データ契約を確定し、EntryScheduler の結果をもとに Discord 通知・集計を自動化する。  
   - 失敗時の再試行・キャンセル・手動復旧の運用導線を定義し、監査ログとヘルス監視に接続する。  
   - Node ランタイムでの実装開始前に、フロント／API 側との合意済み仕様をまとめる。
2. **Introduce モーダル拡張とモデレーション強化**  
   - セレクト項目／NG ワード／添付ファイル可否などの要件を確定し、Bot・API・フロントで共通スキーマを用意する。  
   - Embed 生成・バリデーション・監査ログを拡張し、投稿失敗時の再送フローを整備する。
3. **運用ヘルスチェックと権限監視の仕上げ**  
   - 起動時の権限／ロール検証に加えて、`/health` Slash コマンド（もしくは REST）を実装し、監視チャンネルへの定期通知と `healthRegistry` 永続化を連動させる。  
   - 既存の PresenceManager・ヘルス履歴再構築を活用し、告知フローと Runbook を整理する。
4. **設定バリデーションとホットリロード安全性の向上**  
   - Bot 側での設定 JSON/YAML スキーマ検証と差分ロールバックを用意し、異常検知時は監査ログとヘルス警告を発火する。  
   - Dash/API でも必須項目チェックと UI エラー提示を強化し、リリース前検証を自動化する。
5. **管理 API 永続化と監査ログ拡張**  
   - FastAPI 側のインメモリストレージを永続層（例: SQLite/Postgres）へ置き換え、監査ログの長期保存・フィルタリングを強化する。  
   - 監査 ID から詳細を参照できる API を追加し、ダッシュボードとの連携を整理する。

### 完了済みの短期課題
- **ESCL スクリム応募機能の Node.js 移植完了**（応募ジョブ永続化・復元、Python Slash コマンド無効化まで実施済み）
- **ESCL 認証管理の多アカウント対応**（暗号化 CredentialStore・AccountManager・`/escl account` コマンド・`entry` 系オートコンプリートを実装済み）

## 中期課題（バックエンド・フロントエンド）
- **管理 API の永続化と監査拡張**  
  - SQLite/Postgres 等のストレージ導入、監査ログ長期保存、エクスポートフィルタの強化。  
  - 監査 ID をキーにダッシュボードから詳細参照できるよう API を拡張。
- **Webhook／外部通知連携**  
  - 設定変更や Bot 障害を GitHub / Discord / Ops チャネルへ通知する仕組みを設計。  
  - 将来的な CI/CD（PR マージ時の自動反映）に向けた Webhook 受信エンドポイントを整理。
- **Introduce / Scrims UI の高度化**  
  - 自己紹介フォームのプレビュー強化、NG ワード管理 UI、ファイル添付設定を追加。  
  - スクリム設定のカレンダー表示・実行ログビューアを検討。
- **入力バリデーションとレビュー支援**  
  - フォーム入力時の即時バリデーション・差分サマリ生成。  
  - PR 作成時の自動テンプレート生成やレビューチェックリストを導入。

## インフラ／運用タスク
- **Secrets・権限運用ガイド整備**  
  - Bot トークン、API トークン、GitHub PAT の保管ポリシー・権限スコープ・ローテーション手順を文書化。
- **Welcome／Verify／Roles 文言最終レビュー**  
  - 本番公開用メッセージのレビューと approve 手順を確立し、ダッシュボード既定値を更新。
- **テストギルドでの E2E 検証手順書**  
  - Slash コマンド実行 → 監査ログ確認 → 設定 PR 反映までの流れと失敗時トリアージを標準化。
- **ダッシュボード API × GitHub 同期自動化検討**  
  - Webhook／スケジューラでの PR マージ検知 → Bot 設定更新を自動化する案を比較検討。
- **障害時オペレーション整備**  
  - 監査ログ確認、設定ロールバック、権限再同期、ESCL CLI 障害時の手動実行手順をまとめる。

## 進行管理メモ
- スクリム補助・Introduce 拡張は要件依存度が高いため、先に関係者ヒアリング／仕様ワークショップを実施してから実装に入る。  
- 永続化や Webhook など互換性に影響する変更は、API バージョニング方針を決めた上で段階的に導入する。  
- インフラ文書化・E2E 手順は次回リリースサイクルまでにドラフトを用意し、運用チームレビューを受ける。  
- Bot ヘルスチェックは運用の即効性が高いため、優先課題として開発スプリント初期での着手を想定する。
- PresenceManager でヘルスレジストリを購読し、🟢/⚠️/🛑 のカスタムステータスと `online/idle/dnd` 切り替えで利用可否を即時表示する実装を追加。`npm test` で通知系ユニットテストを含め確認済み。
- ヘルス履歴から起動時に未解消の警告を再構築して `healthRegistry` へ復元し、再起動後でも警告解消時に Discord 通知が届くようにした。
- `bot-runtime` の起動時にリポジトリ直下の `.env` も自動探索するようにし、開発環境での環境変数設定漏れを防止。
- ルート直下の ESCL 関連ユーティリティ／ダンプを整理し、`scripts/escl/` と `data/escl/` 配下へ移動済み。CLI 既定パスも新構成に合わせて更新した。
- Codex ワークコマンドの肥大化を解消するため、`bot-runtime/src/discord/commands/work/` 配下に開始・キャンセル・ステータス・選択 UI を分割し共通整形ロジックも切り出した。次段階では通知処理（`bot-runtime/src/codex/notifications.ts`）のモジュール化検討を視野に入れる。
- Codex 通知処理を `bot-runtime/src/codex/notifications/` 配下に分割し、結果通知・失敗通知・キャンセル通知をそれぞれのモジュールに整理。共通フォーマッタや DiscordActions 初期化のハンドリングを共有化したため、今後の通知チャネル拡張や差分ロギングの追加が容易になった。
- Python ESCL Bot の `/entry` コマンドを `src/esclbot/commands/entry_handler.py` に切り出し、進捗通知／teamId 解決／スレッド生成をそれぞれメソッド化。CLI と共通利用する集計・ファイル名ロジックも `src/esclbot/reports.py` へ集約し、従来の `_safe_name` 共有や巨大関数のスパゲッティ化を解消した。
- 2025-10-18 時点で Python Bot から `/set-team` `/list-active` `/entry` `/entry-now` を撤去し、応募系 Slash コマンドは Node.js 側のみで提供する構成へ移行済み。

## ESCL スクリム自動エントリー Bot v2

### 現状サマリ
- Python 実装で `/set-team` `/list-active` `/entry` と応募スケジューラ（0.5 秒 × 最大 3 回リトライ）が完成済み。ESCL API クライアント、teamId 永続化、ユニットテストも揃っている（現在は Slash コマンド登録を停止中）。
- Node.js ランタイムは Slash コマンド移植と応募ジョブ永続化／復元まで完了し、再起動後も予約が保持される状態を確立した。
- 2025-10-15 時点で ESCL API クライアント・teamId 永続化・スケジューラ／コマンド統合まで開発。スレッド作成失敗フォールバックや 429 対応も組み込み済み。

### 直近の追加要求（2025-10-18）
- `/entry` に任意の時刻を指定できるオプションを追加し、未指定時は前日 0:00 JST を維持する。
- 応募を即時 1 回だけ送信する Slash コマンド（仮称 `/entry-now`）を提供する。
- リトライ回数を 3 回へ縮小し、429 時の待機ロジックなどの制御値を新設定に合わせる（即時コマンドはリトライなしを想定）。

### 次アクション（短期）
1. Python 実装をアップデートし、可変時刻オプション／即時応募コマンド／リトライ 3 回へ切り替える。（完了）
2. 追加要件を満たす形で Node.js ランタイムへ Slash コマンドを移植し、既存の Codex 連携コマンドと併存できるよう整理する。
3. 応募ジョブ永続化レイヤーを設計・導入し、再起動時の復元テストまで実施する。（完了）
4. 移植時の設定・環境変数・権限要件を洗い出し、README や運用手順を更新する。（完了）
5. Node 側で安定稼働を確認したら Python 側の同名 Slash コマンドを無効化／削除し、運用を一本化する。（完了）
6. 詳細な作業手順と進捗管理は `docs/task.md` の Exec Plan（「ESCL スクリム自動エントリー Bot v2」）を参照・更新する。

### 中期検討事項
- 永続化レイヤー導入後の性能計測とメンテナンス手順（バックアップ／ローテーション）を整備する。
- ESCL API のエラーレスポンス（特に 422/429）バリエーションを調査し、Node 実装でも同じ挙動になるようモジュール化する。
- 複数ランタイム（Python / Node）同時運用を避け、コマンド群を一本化する段階的な移行計画を策定する。

### リスク / メモ
- Discord スレッド作成権限が不足するギルドではチャンネル本体で進捗共有するフォールバックが必要。
- JWT の有効期限とローテーション手順を明文化し、深夜帯での失効リスクを抑える。
- Node 移植後に Python 側を停止する場合は、既存の CLI ツール（CSV/XLSX 出力）との整合性を事前確認する。
