# Nyaimlab 次期対応計画

## 現状サマリ
- Node.js ランタイムは `/verify post` `/roles post` `/introduce` `/feedback` を含む主要 Slash コマンドと監査ログ送信、オンボーディング DM フォールバックまで稼働。Verify ロール剥奪監査 (`verify.revoke`) と退会イベント (`member.leave`) も実装済み。
- Python 製 ESCL コレクタは CSV / Excel 生産と再集計ロジックを提供し、Node.js から CLI 経由で呼び出せる。
- FastAPI 管理 API は設定保存・監査ログ検索・スクリム設定ドライランまでカバーするが、ストレージはインメモリで永続化されていない。
- React ダッシュボードは全タブ（Welcome〜Scrims/Settings）、監査ログビューア、YAML 差分＆PR 起票、スクリムドライラン操作まで実装。Introduce 拡張や詳細バリデーションは未着手。
- スクリム補助は API／ダッシュボードで設定・ドライランが可能な段階だが、Bot 側での通知／集計処理は未実装。

## 直近の進捗
- `scripts/create_workflow_session.py` のスラッグ正規化を修正し、空白を含むトピック名でも安定したセッションディレクトリが生成されるようにした。`docs/task.md` に Codex 自動運用タスクセクションを追加し、Orchestrator サイクル用タスクを整理。
- Bot プレゼンスにヘルス状態を反映する PresenceManager を導入し、正常時は `🟢 利用可能`、警告／障害時は `⚠️` / `🛑` を表示して利用可否を即時把握できるようにした。
- Verify ロール剥奪検知に伴う監査ログ (`verify.revoke`) と退会ハンドリング (`member.leave`) を追加し、監査線が整備された。
- Python ESCL CLI を Node.js ランタイムに統合し、`/version` `/escl_from_parent_csv` `/escl_from_parent_xlsx` を Slash コマンドとして公開。
- `/feedback` コマンドを追加し、Discord からのバグ報告／アイデアをローカル Markdown として保存・監査ログ送信する導線を構築。
- `/health` Slash コマンドと PermissionMonitor / HealthHeartbeat を実装し、起動時の権限検証・チャンネル権限不足検知・ロール階層監視・定期ヘルス通知を整備した。
- ダッシュボードの Scrims タブから `dry_run`／`run` を API に投げ、監査 ID を取得できるようにした。
- README を Codex 連携コマンドに合わせて刷新し、`/help` Slash コマンドで主要な操作ガイドを即時参照できるようにした。
- `/help` コマンドにカテゴリ／コマンド指定オプションを追加し、サーバー基本ガイドから個別機能の詳細まで自己完結できるヘルプを提供。
- `/entry` コマンドに任意時刻指定オプションと即時送信用 `/entry-now` を追加し、Python スケジューラのリトライ上限を 3 回へ統一。ユニットテストを更新して新挙動を担保。
- Node.js ランタイムに `/set-team` `/list-active` `/entry` `/entry-now` を実装し、ESCL 応募の予約・即時送信を TypeScript 側で完結できるようにした。TeamStore／EntryScheduler／ESCL API クライアントも移植してユニットテストを整備。
- EntryScheduler に JSON ベースの応募ジョブ永続化と再起動復元を実装し、保存・復元テストでストア整合性と再実行を検証できるようにした。
- `/escl account` サブコマンドと暗号化 CredentialStore を導入し、Slash コマンドからアカウント登録・一覧・削除・デフォルト設定、応募コマンドからのアカウント指定、401 発生時の自動失効マークとローテーション CLI を提供した。
- ESCL 関連コマンド群をコードレビューし、`/escl account` のテンプレートリテラルエスケープ不備と EntryScheduler の認証プロバイダー型定義、tsconfig の `include` 設定漏れを修正して TypeScript ビルドを復旧。
- `/introduce` コマンドに添付画像オプションを追加し、空タイトル設定時は Embed タイトルを省略できるようにした。ステータス項目のプレースホルダーと最大文字数も拡張し、ユーザー要望に対応。
- 管理 API に config.yaml 同期機能を実装し、設定更新時にバックアップ（最新 10 件）を自動取得するようにした。`run_dashboard.sh`／`run_admin_api.sh` から同期が有効化され、ダッシュボードと Bot 設定が即時一致する。

## 優先課題（短期）
1. **スクリム補助ワークフローの Bot 実装**  
   - ダッシュボード／管理 API と連携する通知テンプレート・データ契約を確定し、EntryScheduler の結果をもとに Discord 通知・集計を自動化する。  
   - 失敗時の再試行・キャンセル・手動復旧の運用導線を定義し、監査ログとヘルス監視に接続する。  
   - Node ランタイムでの実装開始前に、フロント／API 側との合意済み仕様をまとめる。
2. **Introduce モーダル拡張とモデレーション強化**（当面は後回し）  
   - セレクト項目／NG ワード／添付ファイル可否などの要件を確定し、Bot・API・フロントで共通スキーマを用意する。  
   - Embed 生成・バリデーション・監査ログを拡張し、投稿失敗時の再送フローを整備する。
3. ~~**運用ヘルスチェックと権限監視の仕上げ**~~（完了）  
   - PermissionMonitor ＋ `/health` コマンド＋ HealthHeartbeat を導入済み。Runbook 更新のみ別タスクで追う。
4. **設定バリデーションとホットリロード安全性の向上**  
   - Bot 側での設定 JSON/YAML スキーマ検証と差分ロールバックを用意し、異常検知時は監査ログとヘルス警告を発火する。  
   - Dash/API でも必須項目チェックと UI エラー提示を強化し、リリース前検証を自動化する。
5. **管理 API 永続化と監査ログ拡張**  
   - FastAPI 側のインメモリストレージを永続層（例: SQLite/Postgres）へ置き換え、監査ログの長期保存・フィルタリングを強化する。  
   - 監査 ID から詳細を参照できる API を追加し、ダッシュボードとの連携を整理する。
6. **管理 API ⇔ bot config.yaml 同期**  
   - FastAPI 起動時に `config.yaml` を読み込みダッシュボードの初期状態へ反映する。  
   - ダッシュボードからの設定更新後に `config.yaml` へ自動で書き戻し、Bot 側と乖離しないようにする。  
   - 差分反映・バックアップ・競合対策など、安全な同期運用のための実装方針を固める。
   - （追記）マルチギルド運用時の同期方針を整理する。ギルド別 YAML の命名規則・同期対象切替・利用者権限を検討し、要件を関係者と擦り合わせる。

### 完了済みの短期課題
- **ESCL スクリム応募機能の Node.js 移植完了**（応募ジョブ永続化・復元、Python Slash コマンド無効化まで実施済み）
- **ESCL 認証管理の多アカウント対応**（暗号化 CredentialStore・AccountManager・`/escl account` コマンド・`entry` 系オートコンプリートを実装済み）
- **運用ヘルスチェックと権限監視の強化**（PermissionMonitor による起動時権限検証、`/health` コマンド、HealthHeartbeat の定期アラート送信を導入）

## 2025-02 Welcome カードモード拡張
- **目的**: 既存の Welcome Embed 投稿に加え、Canvas で合成した画像カードを送信できるようにし、ダッシュボードからモード切替とプレビューを提供する。
- **TODO**
  - [x] `WelcomeConfig` へ `mode` とカード用設定（背景パス・フォント・カラーパレット等）を追加し、config.yaml 同期範囲を更新する。
  - [x] プレビュー API を拡張し、card モード時は生成 PNG を base64 等で返す設計にする（Dash からの確認用）。embed モードも既存データ構造で返却。
  - [x] bot-runtime の OnboardingManager にカード生成パイプライン（node-canvas）を実装し、Discord 送信時に画像添付＋任意メッセージを投稿する。
- [x] ダッシュボード UI にモード選択（embed/card）とカード設定フォーム＋プレビュー表示を追加する。
- [x] タイトル／サブタイトル／本文／アイコンの配置（縦位置・フォントサイズ）をダッシュボードから調整できるようにし、bot-runtime のカード描画ロジックへ反映する。
- **メモ**
  - `canvas` 依存を追加し、フォント・背景パスは config.json 側で絶対 or プロジェクト相対のどちらも扱えるようにする。
  - プレビューは保存 API とは別エンドポイント（例: `/welcome.preview`）で実装し、Dash 上からの確認では永続化しない。
  - ダッシュボード側でカラー picker・フォントプリセット・背景画像プレビューを提供し、視覚的に調整できるようにした。データURL 背景にも対応。

## 2025-10 Welcome カード設定バリデーション
- **目的**: `welcome.card.title_template` が空文字のまま保存されると Zod の最小文字数検証で bot-runtime が起動失敗する問題を解消し、カードモードの安定運用を確保する。
- **TODO**
  - [x] `config.yaml` の `welcome.card.title_template` を非空テンプレート（例: `ようこそ、{{username}} さん！`）へ更新し、`ts-node` 経由の `loadConfig` でバリデーションが通ることを確認する。
  - [ ] ダッシュボードと API で空文字を保存させない UI / バックエンドバリデーションを追加し、再発防止策を実装する。
- **メモ**
  - CLI から `npx ts-node --transpile-only -e "(async () => { const result = await loadConfig(); ... })();"` を実行してホットリロードと起動時検証が正常に通ることを確認済み。

## 中期課題（バックエンド・フロントエンド）
- **管理 API の永続化と監査拡張**  
  - SQLite/Postgres 等のストレージ導入、監査ログ長期保存、エクスポートフィルタの強化。  
  - 監査 ID をキーにダッシュボードから詳細参照できるよう API を拡張。
- **Webhook／外部通知連携**  
  - 設定変更や Bot 障害を GitHub / Discord / Ops チャネルへ通知する仕組みを設計。  
  - 将来的な CI/CD（PR マージ時の自動反映）に向けた Webhook 受信エンドポイントを整理。
- **Introduce / Scrims UI の高度化**  
  - 自己紹介フォームのプレビュー強化、NG ワード管理 UI、ファイル添付設定を追加。  
  - スクリム設定のカレンダー表示・実行ログビューアを検討。
- **入力バリデーションとレビュー支援**  
  - フォーム入力時の即時バリデーション・差分サマリ生成。  
  - PR 作成時の自動テンプレート生成やレビューチェックリストを導入。

## インフラ／運用タスク
- **Secrets・権限運用ガイド整備**  
  - Bot トークン、API トークン、GitHub PAT の保管ポリシー・権限スコープ・ローテーション手順を文書化。
- **Welcome／Verify／Roles 文言最終レビュー**  
  - 本番公開用メッセージのレビューと approve 手順を確立し、ダッシュボード既定値を更新。
- **テストギルドでの E2E 検証手順書**  
  - Slash コマンド実行 → 監査ログ確認 → 設定 PR 反映までの流れと失敗時トリアージを標準化。
- **ダッシュボード API × GitHub 同期自動化検討**  
  - Webhook／スケジューラでの PR マージ検知 → Bot 設定更新を自動化する案を比較検討。
- **障害時オペレーション整備**  
  - 監査ログ確認、設定ロールバック、権限再同期、ESCL CLI 障害時の手動実行手順をまとめる。

## 進行管理メモ
- スクリム補助・Introduce 拡張は要件依存度が高いため、先に関係者ヒアリング／仕様ワークショップを実施してから実装に入る。  
- 永続化や Webhook など互換性に影響する変更は、API バージョニング方針を決めた上で段階的に導入する。  
- インフラ文書化・E2E 手順は次回リリースサイクルまでにドラフトを用意し、運用チームレビューを受ける。  
- Bot ヘルスチェックは運用の即効性が高いため、優先課題として開発スプリント初期での着手を想定する。
- PresenceManager でヘルスレジストリを購読し、🟢/⚠️/🛑 のカスタムステータスと `online/idle/dnd` 切り替えで利用可否を即時表示する実装を追加。`npm test` で通知系ユニットテストを含め確認済み。
- ヘルス履歴から起動時に未解消の警告を再構築して `healthRegistry` へ復元し、再起動後でも警告解消時に Discord 通知が届くようにした。
- PermissionMonitor でギルド権限（ManageRoles）、チャンネル権限不足、ロール階層の問題を検知し `healthRegistry` に反映。HealthHeartbeat が継続警告を定期通知することで Runbook の確認漏れを防ぐ。
- `bot-runtime` の起動時にリポジトリ直下の `.env` も自動探索するようにし、開発環境での環境変数設定漏れを防止。
- ルート直下の ESCL 関連ユーティリティ／ダンプを整理し、`scripts/escl/` と `data/escl/` 配下へ移動済み。CLI 既定パスも新構成に合わせて更新した。
- Codex ワークコマンドの肥大化を解消するため、`bot-runtime/src/discord/commands/work/` 配下に開始・キャンセル・ステータス・選択 UI を分割し共通整形ロジックも切り出した。次段階では通知処理（`bot-runtime/src/codex/notifications.ts`）のモジュール化検討を視野に入れる。
- Codex 通知処理を `bot-runtime/src/codex/notifications/` 配下に分割し、結果通知・失敗通知・キャンセル通知をそれぞれのモジュールに整理。共通フォーマッタや DiscordActions 初期化のハンドリングを共有化したため、今後の通知チャネル拡張や差分ロギングの追加が容易になった。
- Python ESCL Bot の `/entry` コマンドを `src/esclbot/commands/entry_handler.py` に切り出し、進捗通知／teamId 解決／スレッド生成をそれぞれメソッド化。CLI と共通利用する集計・ファイル名ロジックも `src/esclbot/reports.py` へ集約し、従来の `_safe_name` 共有や巨大関数のスパゲッティ化を解消した。
- 2025-10-18 時点で Python Bot から `/set-team` `/list-active` `/entry` `/entry-now` を撤去し、応募系 Slash コマンドは Node.js 側のみで提供する構成へ移行済み。
- Discord.js v14 系で非推奨となった `ephemeral` オプションを排し、Slash Command の応答／保留は `MessageFlags.Ephemeral` へ統一。`/list-active` など一部の即時応答も整理し、警告ログの発生を抑制した。
- PermissionMonitor のギルド取得失敗ログを重複抑制し、`Unknown Guild` 応答時には設定 ID や Bot 参加状況の再確認を促す詳細理由をヘルス警告へ記録するよう改善した。
- HealthHeartbeat が同一内容を短時間に繰り返し送信しないよう抑制し、既定で 6 時間は同じ警告メッセージを再投稿しない設計に変更した（`HEALTH_HEARTBEAT_REPEAT_SUPPRESS_MS` で調整可）。
- 自己紹介の添付画像はコマンド実行時の一時 URL を再アップロードし直す設計とし、最大 8MB・画像 MIME のみ許容。未指定時は従来どおりユーザーのアイコンをサムネイルに使用する。

## ESCL スクリム自動エントリー Bot v2

### 現状サマリ
- Python 実装で `/set-team` `/list-active` `/entry` と応募スケジューラ（0.5 秒 × 最大 3 回リトライ）が完成済み。ESCL API クライアント、teamId 永続化、ユニットテストも揃っている（現在は Slash コマンド登録を停止中）。
- Node.js ランタイムは Slash コマンド移植と応募ジョブ永続化／復元まで完了し、再起動後も予約が保持される状態を確立した。
- 2025-10-15 時点で ESCL API クライアント・teamId 永続化・スケジューラ／コマンド統合まで開発。スレッド作成失敗フォールバックや 429 対応も組み込み済み。

### 直近の追加要求（2025-10-18）
- `/entry` に任意の時刻を指定できるオプションを追加し、未指定時は前日 0:00 JST を維持する。
- 応募を即時 1 回だけ送信する Slash コマンド（仮称 `/entry-now`）を提供する。
- リトライ回数を 3 回へ縮小し、429 時の待機ロジックなどの制御値を新設定に合わせる（即時コマンドはリトライなしを想定）。

### 次アクション（短期）
1. Python 実装をアップデートし、可変時刻オプション／即時応募コマンド／リトライ 3 回へ切り替える。（完了）
2. 追加要件を満たす形で Node.js ランタイムへ Slash コマンドを移植し、既存の Codex 連携コマンドと併存できるよう整理する。
3. 応募ジョブ永続化レイヤーを設計・導入し、再起動時の復元テストまで実施する。（完了）
4. 移植時の設定・環境変数・権限要件を洗い出し、README や運用手順を更新する。（完了）
5. Node 側で安定稼働を確認したら Python 側の同名 Slash コマンドを無効化／削除し、運用を一本化する。（完了）
6. 詳細な作業手順と進捗管理は `docs/task.md` の Exec Plan（「ESCL スクリム自動エントリー Bot v2」）を参照・更新する。

### 中期検討事項
- 永続化レイヤー導入後の性能計測とメンテナンス手順（バックアップ／ローテーション）を整備する。
- ESCL API のエラーレスポンス（特に 422/429）バリエーションを調査し、Node 実装でも同じ挙動になるようモジュール化する。
- 複数ランタイム（Python / Node）同時運用を避け、コマンド群を一本化する段階的な移行計画を策定する。

## RAG / ローカル LLM 拡張計画（2025-05）
- 目的: ローカル LLM（Ollama）と RAGFlow + Chroma を組み合わせ、Discord 会話から感情トリガーで自発発話・メンション応答・ナレッジ参照ができるキャラクターボットを育成する。
- 環境: `.venv-rag` を新設し、RAG 専用依存（ragflow / chromadb / fastapi / uvicorn など）を分離管理する。既存 `.venv` とは共有しない。
- サービス構成: FastAPI ベースの RAG サービスを独立プロセスで起動。`/events/message`（監視）、`/chat/query`（回答）、`/health`、`/admin/*` を expose し、Node ランタイムから HTTP 連携する。感情パラメータや心の声生成を内部ジョブで管理。
- ナレッジ: Markdown（`docs/rag/knowledge/*.md`）を取り込み、front-matter でタイトル／タグ／チャンネルヒントを付与。Chroma は `data/chroma/` に永続化し、重要チャンネル専用コレクションと一般会話コレクションを分割する。
- コマンド案: `/rag status` `/rag ingest` `/rag memo add` `/rag memory prune` `/rag feeling set` `/rag mode`. メンション応答モード（help/coach/chat）と自発発話頻度パラメータを操作可能にする。
- 感情モデル: 「興味」「共感」「緊急度」の3軸 + クールダウン／確率制御。定期的な「心の声」を Chroma に保存し、しきい値超過時やメンション時に Discord へ発話。Aim/イベント情報など重要チャンネルは優先検索する。
- 今後のタスク:
  1. `.venv-rag` 作成と依存固定（`requirements-rag.txt`）・起動スクリプト整備。
  2. RAG サービス雛形（FastAPI + Ollama クライアント + Chroma ストレージ）の実装。
  3. Discord 側 Slash コマンドと管理ダッシュボード UI の仕様確定、メッセージ監視パイプラインの実装。
  4. 感情パラメータ・心の声ロジックのチューニングとメモリ pruning 運用手順の策定。

### 進捗メモ
- 2025-10-28: RAG サービス骨格（FastAPI + Chroma + Ollama クライアント）と `.venv-rag` 管理スクリプトを追加。
- 2025-10-28: Discord 側に `/rag status|mode|feeling` コマンドと RagClient ラッパーを実装し、RAG サービスのヘルス確認とパラメータ調整を可能にした。
- 2025-10-28: メッセージ監視から RAG へのイベント送信、`/rag ingest|memo add|memory prune` を実装し、ナレッジ取り込みと記憶メンテナンスの基本操作を整備。
- 2025-10-28: PyPI の `ragflow` が 0.0.1 のみで依存解決できなかったため、暫定的に requirements-rag から除外（SimpleHasherEmbedding を利用中）。正式対応では RagFlow のインストール手順を再検討する。
- 2025-10-29: Qwen-3 14B の GGUF 変換・量子化ガイドと Modelfile を追加し、`.env.rag` の既定モデルを `qwen3-14b-q4km` へ切り替え。README から参照可能にした。
- 2025-10-29: ダッシュボードに RAG 管理タブを追加し、プロンプト・感情・短期記憶除外・ナレッジ登録を GUI で操作できるようにした。管理 API と RAG サービスも設定ホットリロードに対応。
- 2025-10-29: ダッシュボード Welcome プレビューがドラフト再生成で常時リフレッシュされていた不具合を修正し、人数表示がサンプル値であることを UI 上で明示した。
- 2025-10-29: Welcome 設定初期ロード時に `draftState` が未設定でも描画できるようガードを追加。
- 2025-11-03: CodeX ワークフロー再編として `.codex/` ガイド、`.workflow-sessions/` テンプレート、README の AI 運用ガイドを整備。計画／実装／レビュー／ドキュメントの役割分担を明文化し、長期運用の基盤を確立した。
- 2025-11-03: `.workflow-sessions` のセッション自動生成スクリプトとプロンプト依存関係図を追加し、CodeX が完全自動で作業サイクルを開始できる体制を構築。

### リスク / メモ
- Discord スレッド作成権限が不足するギルドではチャンネル本体で進捗共有するフォールバックが必要。
- JWT の有効期限とローテーション手順を明文化し、深夜帯での失効リスクを抑える。
- Node 移植後に Python 側を停止する場合は、既存の CLI ツール（CSV/XLSX 出力）との整合性を事前確認する。
