# Botランタイム基盤（discord.js v14）実装計画

## 目的とスコープ
- Node.js + discord.js v14構成でBotプロセスの土台を整備する。
- `config.yaml`から設定を読み込み、変更を検知してホットリロードする仕組みを実装する。
- Slash Command登録や主要イベントリスナー（`guildMemberAdd`, `interactionCreate`など）の土台を準備し、後続機能追加のベースを作る。

## 実装ステップ
1. **プロジェクト初期化** ✅（完了）
   - `pnpm`または`npm`でTypeScript対応のNode.jsプロジェクトを作成。
   - `discord.js`, `dotenv`, `ts-node`, `typescript`, `@types/node`など主要依存を導入。
   - `src/index.ts`エントリを用意し、環境変数（`DISCORD_TOKEN`, `GUILD_ID`など）を読み込む。

2. **設定ローダー整備** ✅（完了）
   - `js-yaml`とZod等を用いて`config.yaml`の読み込み＋バリデーションを実装。
   - 設定スキーマ（guild情報、チャンネルID、ロール設定、フラグ群）を定義し、型安全にアクセスできるようにする。
   - 初回読み込み時にバリデーション結果とエラーを標準出力／監査ログへ記録する仕組みを準備。

3. **ホットリロード機構** ✅（完了）
   - `setInterval`等で設定リポジトリを60秒間隔でフェッチし、ファイルの更新タイムスタンプまたはハッシュを比較。
   - 変更検知時に設定を再ロードし、Botの状態（Embedテンプレートやロール定義など）を更新する。
   - リロード時は差分を監査ログに送信し、エラー発生時は前回の設定をロールバックする仕組みを整える。

4. **Discordクライアント基盤** ✅（完了）
   - `GatewayIntentBits`と`Partials`を設計メモに沿って設定（ギルドメンバー、メッセージ、リアクションなど必要なIntentを有効化）。
   - `client.login`の前にSlash Command定義を読み込み、起動時に`REST` API経由でコマンド同期を行う。
   - `interactionCreate`, `guildMemberAdd`, `messageReactionAdd`など主要イベントのハンドラ登録とエラーハンドリング（try/catch + 監査ログ）を実装。

5. **監査ログ基盤** ✅（完了）
   - 設計に記載のJSONフォーマットで`#audit_log`チャンネルに投稿するユーティリティを実装。
   - 成功・失敗イベントを共通関数経由で送信し、追加ストレージへの拡張が可能な構造にする。

6. **起動・開発フロー整備** ✅（完了）
   - `package.json`に`dev`（`ts-node-dev`等）と`build`スクリプトを追加。
   - `.env.example`を作成し、必要な環境変数を明示。
   - READMEまたは運用ドキュメントに起動手順・依存関係・設定配置について記載。

7. **オンボーディングフロー整備** ✅（完了）
   - `guildMemberAdd`で歓迎Embed・ボタンを投稿する`OnboardingManager`を導入。
   - ガイド/ロール案内ボタンやDMテンプレートを`config.yaml`の`onboarding`セクションで管理。
   - DM送信失敗時にスレッドを自動生成し、監査ログへ遷移を記録する仕組みを実装。

## 検討事項
- 設定リポジトリとの同期方式を後続でWebhook駆動に切り替える場合に備え、フェッチ処理を抽象化しておく。
- Botロールの権限不足による失敗ケースを早期検出できるよう、起動時にロール階層チェックを導入するか検討。
- ローカル開発時に実環境ギルドへ影響を与えないよう、ステージング用ギルドIDを環境変数で切り替え可能にする。
