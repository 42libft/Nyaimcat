---
title: 'フォローアップ: フォローアップ: Botのステータス'
priority: normal
priority_label: 通常
summary: read-only未解除のおわび
created_at: '2025-10-18T04:17:23.731Z'
author:
  id: '802792088893652992'
  tag: no_libft_no_life
channel_id: '1411214661612867624'
interaction_id: '1428960124893921431'
parent:
  run_id: 55d8e6ff-8fa8-4a5e-93f6-93c7700a54ae
  queue_id: f6cc4e2c-31e5-408f-9b94-50b6f4233a9d
  task_filename: 2025-10-18T04-05-58-288Z-フォローアップ-botのステータス.md
  history_path: >-
    /Users/ashu/Desktop/Discord_Bot/Nyaimlab/tasks/runs/2025-10-18T04-09-04-530Z-55d8e6ff-8fa8-4a5e-93f6-93c7700a54ae-2025-10-18T04-05-58-288Z---------bot------.json
---

## 概要

read-only未解除のおわび

## 詳細

### 元タスク情報

- タイトル: フォローアップ: Botのステータス
- ファイル名: `2025-10-18T04-05-58-288Z-フォローアップ-botのステータス.md`
- 優先度: 通常
- 概要: 機能実装のお願い
- 履歴ファイル: `/Users/ashu/Desktop/Discord_Bot/Nyaimlab/tasks/runs/2025-10-18T04-09-04-530Z-55d8e6ff-8fa8-4a5e-93f6-93c7700a54ae-2025-10-18T04-05-58-288Z---------bot------.json`

### 前回の Codex 応答
```markdown
リポジトリが read-only のままだったため直接の修正は適用できませんでしたが、ステータス実装に必要な差分を以下にまとめました。

**実装差分案**
- `bot-runtime/src/discord/presenceManager.ts` を新設し、`healthRegistry` を購読して BOT プレゼンスを `online / idle / dnd` とカスタムステータス文言に切り替えるロジックを実装。
- `bot-runtime/src/discord/client.ts` に PresenceManager を組み込み、`ready` ハンドラと `applyConfigUpdate` からプレゼンス更新を呼び出すように変更。
- `docs/plans.md` の進行管理メモへ今回の対応方針を追記。

```diff
diff --git a/bot-runtime/src/discord/client.ts b/bot-runtime/src/discord/client.ts
index 9e7154c..e2fcb84 100644
--- a/bot-runtime/src/discord/client.ts
+++ b/bot-runtime/src/discord/client.ts
@@
 import { RolesPanelManager } from "./roles/manager";
 import { IntroduceManager } from "./introduce/manager";
 import { CodexFollowUpManager } from "./codex/followUpManager";
+import { PresenceManager } from "./presenceManager";
@@
   private verifyManager: VerifyManager;
   private rolesManager: RolesPanelManager;
   private introduceManager: IntroduceManager;
   private codexFollowUpManager: CodexFollowUpManager;
+  private presenceManager: PresenceManager;
@@
     this.rolesManager = new RolesPanelManager(
       this.client,
       this.auditLogger,
       this.config
     );
     this.introduceManager = new IntroduceManager(this.auditLogger, this.config);
+    this.presenceManager = new PresenceManager(this.client);
@@
     this.auditLogger.updateConfig(config);
     this.onboarding.updateConfig(config);
     this.verifyManager.updateConfig(config);
     this.rolesManager.updateConfig(config);
     this.introduceManager.updateConfig(config);
+    void this.presenceManager.refresh();
@@
     this.client.on("ready", () => {
       if (!this.client.user) {
         return;
       }
+
+      this.presenceManager.start();
@@
       logger.info("Discord クライアントが起動しました", {
         user: this.client.user.tag,
         id: this.client.user.id,
       });
```

```diff
diff --git a/bot-runtime/src/discord/presenceManager.ts b/bot-runtime/src/discord/presenceManager.ts
new file mode 100644
--- /dev/null
+++ b/bot-runtime/src/discord/presenceManager.ts
@@
+import { ActivityType, type Client, type PresenceData } from "discord.js";
+import { collectHealthIssueSummary } from "../health/summary";
+import { healthRegistry } from "../health/registry";
+import { logger } from "../utils/logger";
+
+const MAX_STATE_LENGTH = 80;
+
+const truncate = (value: string, limit: number) =>
+  value.length > limit ? `${value.slice(0, limit - 1)}…` : value;
+
+const stripPrefix = (line: string) => line.replace(/^[🛑⚠️]\s+/, "").trim();
+
+const stripDetectedAt = (line: string) =>
+  line.replace(/\s*\(検知:[^)]+\)\s*$/, "").trim();
+
+export class PresenceManager {
+  private unsubscribe?: () => void;
+  private started = false;
+
+  constructor(private readonly client: Client) {}
+
+  start() {
+    if (this.started) {
+      return;
+    }
+
+    this.unsubscribe = healthRegistry.subscribe({
+      onReport: () => this.handleHealthChange(),
+      onResolve: () => this.handleHealthChange(),
+    });
+
+    this.started = true;
+    void this.refresh();
+  }
+
+  stop() {
+    if (!this.started) {
+      return;
+    }
+
+    this.unsubscribe?.();
+    this.unsubscribe = undefined;
+    this.started = false;
+  }
+
+  async refresh() {
+    if (!this.started || !this.client.isReady() || !this.client.user) {
+      return;
+    }
+
+    const presence = this.buildPresence();
+
+    try {
+      await this.client.user.setPresence(presence);
+      logger.debug("Discord プレゼンスを更新しました", {
+        status: presence.status,
+        activity: presence.activities?.[0]?.state ?? presence.activities?.[0]?.name,
+      });
+    } catch (error) {
+      logger.warn("Discord プレゼンス更新に失敗しました", {
+        message: error instanceof Error ? error.message : String(error),
+      });
+    }
+  }
+
+  private handleHealthChange() {
+    void this.refresh();
+  }
+
+  private buildPresence(): PresenceData {
+    const issues = healthRegistry.list();
+
+    if (issues.length === 0) {
+      return {
+        status: "online",
+        activities: [
+          {
+            type: ActivityType.Custom,
+            name: "Custom Status",
+            state: "🟢 利用可能",
+          },
+        ],
+      };
+    }
+
+    const hasError = issues.some((issue) => issue.level === "error");
+    const prefix = hasError ? "🛑 障害対応中" : "⚠️ 警告中";
+    const summary = collectHealthIssueSummary(1);
+    const topLine = summary.lines[0] ? stripDetectedAt(stripPrefix(summary.lines[0])) : "";
+    const countSuffix = summary.total > 1 ? ` (+${summary.total - 1})` : "";
+    const stateBase =
+      topLine.length > 0 ? `${prefix} | ${topLine}${countSuffix}` : `${prefix}${countSuffix}`;
+    const state = truncate(stateBase, MAX_STATE_LENGTH);
+
+    return {
+      status: hasError ? "dnd" : "idle",
+      activities: [
+        {
+          type: ActivityType.Custom,
+          name: "Custom Status",
+          state,
+        },
+      ],
+    };
+  }
+}
```

```diff
diff --git a/docs/plans.md b/docs/plans.md
index 9dd2817..0603620 100644
--- a/docs/plans.md
+++ b/docs/plans.md
@@
 - インフラ文書化・E2E 手順は次回リリースサイクルまでにドラフトを用意し、運用チームレビューを受ける。  
 - Bot ヘルスチェックは運用の即効性が高いため、優先課題として開発スプリント初期での着手を想定する。  
+- Bot プレゼンスにヘルスステータスを反映する PresenceManager 実装を着手。ヘルス警告件数に応じてオンライン/アイドル/DNDへ切り替え、主要警告内容をステータスメッセージに露出させる。
```

**次のステップ**
- 上記差分を適用できる書き込み環境に切り替えたうえで `git apply` などで反映してください。
- `npm run lint` や `npm run test` があれば実行し、問題ないことを確認。
- `npm run dev` などで Bot を起動し、ヘルス状態に応じて Discord 上のステータスが `🟢/⚠️/🛑` と `online/idle/dnd` に切り替わるか確認してください。

書き込み権限が復旧したら再度ご連絡いただければ、こちらで適用と検証まで対応します。
```

### 追加依頼内容

先ほど確認したところ、再起動前のフォローアップ依頼は旧環境変数で実行されるということを失念しておりました。今回お願いした内容をどこかにドキュメントで保存しておいて、次のセッションで依頼しやすいようにしておいていただくことは可能でしょうか？

### 参考: 元タスク本文

## 概要

機能実装のお願い

## 詳細

### 元タスク情報

- タイトル: Botのステータス
- ファイル名: `2025-10-18T03-45-44-909Z-botのステータス.md`
- 優先度: 通常
- 概要: BOTが使用可能かどうかステータスでわかるようにしたい。

### 前回の Codex 応答
```markdown
**対応案**
- `bot-runtime/src/discord/client.ts` の `ready` ハンドラで PresenceManager を初期化し、起動直後とヘルスイベント発生時にステータスを更新できるよう `healthRegistry.subscribe` を呼び出す。
- `bot-runtime/src/discord/presenceManager.ts`（新規）を用意し、`collectHealthIssueSummary` を使ってヘルス警告の有無に応じて `status`（`online`/`idle`/`dnd`）とアクティビティ文言（例: `🟢 利用可能`, `⚠️ 警告中`, `🛑 障害対応中`）を切り替える処理を実装する。
- 設定ホットリロード時にも現在の構成／ヘルス結果で Presence を再計算できるよう、`DiscordRuntime.applyConfigUpdate` から PresenceManager の `refresh` を呼ぶフックを追加する。

**確認方法**
- `npm run dev` でローカル起動し、Discord クライアント上でステータスが `🟢 利用可能` などに変わることを確認する。
- 通知チャンネル未設定などでヘルス警告を強制発生させ、Presence が `⚠️`／`🛑` 系の文言と `idle`／`dnd` に遷移するか確認する。
- 警告を解消した際に Presence が自動で正常状態へ戻ることを確認する。

**補足**
- 現在の実行環境は read-only のためコード変更はまだ行っていません。書き込み可能になったら上記手順で実装し、合わせて `docs/plans.md` に今回の対応方針と決定事項を追記してください。
- ステータス文言は依頼者の希望に合わせて調整可能です。必要であれば将来的に設定ファイル経由でカスタマイズできるよう拡張する選択肢もあります。
```

### 追加依頼内容

read-onlyの方を先ほど解除しましたので、実際に機能を実装して欲しいと思います。

### 参考: 元タスク本文

## 概要

BOTが使用可能かどうかステータスでわかるようにしたい。

## 詳細

› 今このDiscord Botって僕のPCが起動しているかつ、ネットにつながっている状態じゃないと使用できないんだよね。なので、にゃいむきゃっと（BOT名）のステータスで使用可能かどうかわかるといいんだけど可能ですか？可能であれば作業お願いします。

---

_このタスクはDiscord Slash Commandから自動生成されました。_

---

_このタスクは Codex フォローアップ機能から自動生成されました (Run ID: de1818bc-dc1a-4b1c-abf4-194652f64bca)。_

---

_このタスクは Codex フォローアップ機能から自動生成されました (Run ID: 55d8e6ff-8fa8-4a5e-93f6-93c7700a54ae)。_