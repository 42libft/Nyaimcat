# エラーハンドリングとフォールバック

## 基本方針
CodeX は可能な限り自動復旧を試みつつ、失敗状況をセッションログと docs に正確に残すことを優先します。再試行は最大 3 回まで行い、同一原因の再発を防ぐために対応策を記録します。

## 障害レベル分類
- **Warning**: 軽微な警告。即座に作業継続可能だが、`session_status.json.notes` にメモを残す。例: 非推奨 API の検出。
- **Error**: 作業をブロックする障害。再試行後も解消しない場合は `state` を `blocked` に設定し、復旧計画を `03_review.md` または `04_implementation.md` に記載。
- **Critical**: 環境破壊やデータ損失の恐れがある重大障害。直ちに処理を停止し、Planner へエスカレーション。`docs/plans.md` に緊急タスクを追加。

## 再試行プロセス
1. **原因特定**: ログを収集し、発生箇所と影響範囲を明文化。
2. **暫定対応**: 設定修正やキャッシュクリアなど即効性のある手段を試行。
3. **再試行**: 同一手順で最大 2 回再実行。コマンドラインには `--retry` や `--force` を用いず、状況を記録する。
4. **フォールバック**: 失敗が続く場合は作業を部分完了として切り上げ、フォローアップタスクを `docs/tasks.md` へ追加。

## ログと記録
- 自動修復プロセスは `04_implementation.md` に箇条書きで残す。Reviewer が検証できるよう、再現手順と改善策を併記。
- Discord 通知を送る場合は `DiscordActions` を用い、通知メッセージにセッション名と影響範囲を明記する。
- 重大事故時は `.codex/agents/health-checker.md` の手順に従い、監視指標や再実行ポリシーを見直す。

## 共通チェックリスト
- [ ] 再試行前に最新の `git status` を取得し、未コミット変更を把握したか。
- [ ] `.workflow-sessions/<session>/session_status.json` の `updated_at` を更新したか。
- [ ] 失敗の根本原因を `04_implementation.md` で明文化したか。
- [ ] フォローアップが必要な場合、`docs/tasks.md` にチケット化したか。
- [ ] 監視対象（Health-Checker）がある場合、該当ルールを更新したか。
